services:
  # TRAEFIK - Reverse Proxy y Load Balancer
  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      # API y Dashboard
      - "--api.insecure=true"
      - "--api.dashboard=true"

      # Logs
      - "--log.level=INFO"
      - "--accesslog=true"

      # Proveedor Docker
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=rqlite-network"

      # EntryPoints
      - "--entrypoints.web.address=:80"

      # Health check
      - "--ping=true"
    ports:
      - "80:80"
      - "8080:8080"  # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - rqlite-network
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # NODO 1 - Bootstrap del cluster (primer nodo)
  rqlite-node1:
    image: rqlite/rqlite:9.2.1
    container_name: rqlite-node1
    command:
      - -node-id=1
      - -http-addr=0.0.0.0:4001
      - -raft-addr=0.0.0.0:4002
      - -bootstrap-expect=5      
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.rqlite.loadbalancer.server.port=4001"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.path=/status"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.interval=5s"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.timeout=3s"
      - "traefik.http.routers.rqlite.rule=PathPrefix(`/`)"
      - "traefik.http.routers.rqlite.entrypoints=web"
      - "traefik.http.routers.rqlite.service=rqlite"
    networks:
      - rqlite-network
    volumes:
      - rqlite-node1-data:/rqlite/data
    restart: unless-stopped

  # NODO 2
  rqlite-node2:
    image: rqlite/rqlite:9.2.1
    container_name: rqlite-node2
    command:
      - -node-id=2
      - -http-addr=0.0.0.0:4001
      - -raft-addr=0.0.0.0:4002
      - -join=rqlite-node1:4002
      - -join-attempts=60
      - -join-interval=2s      
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.rqlite.loadbalancer.server.port=4001"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.path=/status"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.interval=5s"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.timeout=3s"
    networks:
      - rqlite-network
    volumes:
      - rqlite-node2-data:/rqlite/data
    depends_on:
      - rqlite-node1
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4001/status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: on-failure

  # NODO 3
  rqlite-node3:
    image: rqlite/rqlite:9.2.1
    container_name: rqlite-node3
    command:
      - -node-id=3
      - -http-addr=0.0.0.0:4001
      - -raft-addr=0.0.0.0:4002
      - -join=rqlite-node1:4002
      - -join-attempts=60
      - -join-interval=2s      
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.rqlite.loadbalancer.server.port=4001"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.path=/status"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.interval=5s"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.timeout=3s"
    networks:
      - rqlite-network
    volumes:
      - rqlite-node3-data:/rqlite/data
    depends_on:
      - rqlite-node1
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4001/status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: on-failure

  # NODO 4
  rqlite-node4:
    image: rqlite/rqlite:9.2.1
    container_name: rqlite-node4
    command:
      - -node-id=4
      - -http-addr=0.0.0.0:4001
      - -raft-addr=0.0.0.0:4002
      - -join=rqlite-node1:4002
      - -join-attempts=60
      - -join-interval=2s
    labels:
      - "traefik.enable=true" 
      - "traefik.http.services.rqlite.loadbalancer.server.port=4001"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.path=/status"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.interval=5s"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.timeout=3s"
    networks:
      - rqlite-network
    volumes:
      - rqlite-node4-data:/rqlite/data
    depends_on:
      - rqlite-node1
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4001/status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: on-failure

  # NODO 5
  rqlite-node5:
    image: rqlite/rqlite:9.2.1
    container_name: rqlite-node5
    command:
      - -node-id=5
      - -http-addr=0.0.0.0:4001
      - -raft-addr=0.0.0.0:4002
      - -join=rqlite-node1:4002
      - -join-attempts=60
      - -join-interval=2s
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.rqlite.loadbalancer.server.port=4001"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.path=/status"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.interval=5s"
      - "traefik.http.services.rqlite.loadbalancer.healthcheck.timeout=3s"
    networks:
      - rqlite-network
    volumes:
      - rqlite-node5-data:/rqlite/data
    depends_on:
      - rqlite-node1
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4001/status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: on-failure

networks:
  rqlite-network:
    driver: bridge

volumes:
  rqlite-node1-data:
  rqlite-node2-data:
  rqlite-node3-data:
  rqlite-node4-data:
  rqlite-node5-data:
